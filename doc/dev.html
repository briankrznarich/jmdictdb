<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Development Environment</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_development_environment">Development Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This document describes setting up an environment for doing development
work on the JMdictDB code.  This environment will allow the Apache
web server serve the JMdictDB web pages directly from your
development directory with a dedicated database allowing you
to change the code and see the results without affecting deployed
production code or database.</p>
</div>
<div class="paragraph">
<p>In this document the following are placeholders which should be
replaced with actual values:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">{{DEVDIR}}</dt>
<dd>
<p>Directory where the JMdictDB code has been checked
out from Git.  Example value: ~/devel/jmdictdb/</p>
</dd>
<dt class="hdlist1">{{DEVDB}}</dt>
<dd>
<p>Name of a disposable database in Postgresql to use
for development work.  Example value: jmdevel</p>
</dd>
<dt class="hdlist1">{{DEVDB-SVC}}</dt>
<dd>
<p>Database service name in config-pvt.ini that is
configured to access {{DEVDB}}.  Example value: jmdevel.
confi-pvt.ini will contains a section named "db_jmdevel" that
contains credentials allowing access to the "jmdev" database in
Postgresql.</p>
</dd>
<dt class="hdlist1">{{URLROOT}}</dt>
<dd>
<p>URL root that the Apache web server will be configured
to serve the JMdictDB development pages under.  Example value:
jmdev.  The web server will serve the development files in {{DEVDIR}}
under the URL https://localhost/jmdev/.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="_1_get_the_jmdictdb_software">1. Get the JMdictDB software</h3>
<div class="paragraph">
<p>Generally one should do development of a new JMdictDB "feature" on
a new Git branch dedicated for those changes.  The new branch
should be based off of one of the two on-going JMdictDB branches:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>master&#8201;&#8212;&#8201;Most new changes should be done on a new branch based
on the "master" branch.  After testing and integration they will
be merged back into "master" and will be available in the
production environment the next time it is upgraded.</p>
</li>
<li>
<p>edrdg&#8201;&#8212;&#8201;This branch is the code currently deployed at edrdg.com
and should be reserved for emergency bug fixes that need to be
deployed immediately at that site without waiting for the
normal cycle of upgrading to the latest code in "master".</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_1_1_get_a_fresh_copy_or_update_the_jmdictdb_software">1.1. Get a fresh copy or update the JMdictDB software</h4>
<div class="paragraph">
<p>In the following we&#8217;ll use {{DEVDIR}} to denote the directory you
want to use for the development code, and &lt;BRANCH&gt; for the name
of your feature branch.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ git clone https://gitlab.com/yamagoya/jmdictdb.git {{DEVDIR}}
$ cd {{DEVDIR}}</pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, if you have an existing development directory you
can cd to it and do <code>git checkout master; git pull</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_1_2_create_a_new_branch_from_branch_master">1.2. Create a new branch from branch "master"</h4>
<div class="literalblock">
<div class="content">
<pre>$ git checkout -b &lt;BRANCH&gt; master</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_2_database">2. Database</h3>
<div class="paragraph">
<p>We&#8217;ll use {{DEVDB}} to denote the name of the database you&#8217;ll use
for development work.  You can name it whatever you want but
since the database server may serve other databases having nothing
to do with JMdictDB the author&#8217;s convention is to use names prefixed
with "jm".</p>
</div>
<div class="sect3">
<h4 id="_2_1_make_a_copy_of_the_current_jmdict_database">2.1. Make a copy of the current jmdict database</h4>
<div class="paragraph">
<p>This will create a temporary, throw-away database to use while doing
development work.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ dropdb --if-exists {{DEVDB}}     # In case there is a old version.
$ createdb -Ojmdictdb {{DEVDB}}    # That's -Oh, not -zero.
$ pg_dump jmdict | psql -d {{DEVDB}}</pre>
</div>
</div>
<div class="paragraph">
<p>It is not strictly necessary to create a separate database for
development work; you can access any database from your development
code as long as the database version is compatible but if your work
involves database changes such as adding tags or schema changes
you&#8217;ll want to develop and test them in a separate database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_2_2_apply_any_needed_database_updates">2.2. Apply any needed database updates:</h4>
<div class="literalblock">
<div class="content">
<pre>$ tools/dbversion.py {{DEVDB}}</pre>
</div>
</div>
<div class="paragraph">
<p>If the api and database version are compatible, you&#8217;re all set.  If
it reports something like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>code expects updates: a921f4
{{DEVDB}}: incompatible, missing updates: a921f4, has updates: 7256aa</pre>
</div>
</div>
<div class="paragraph">
<p>then look in db/updates/ for a series of updates that will bring
you from, in this example, 7256aa to a921f4.  At the time of writing,
there are three that follow 028-7256aa.sql:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>029-000000.sql  029-835781.sql  030-a921f4.sql</pre>
</div>
</div>
<div class="paragraph">
<p>Apply each, in order, eg:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>psql -d{{DEVDB}} -Ujmdictdb -f 029-000000.sql
psql -d{{DEVDB}} -Ujmdictdb -f 029-835781.sql
psql -d{{DEVDB}} -Ujmdictdb -f 030-a921f4.sql</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_2_3_check_direct_non_web_access">2.3. Check direct (non-web) access</h4>
<div class="paragraph">
<p>You should now be able to access the development database with the
command line tools.  <code>shentr.py</code> can provide a useful test:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ bin/shentr.py -d{{DEVDB}} -q 1408370
Entry: jmdict 1408370 A {1974702}
Kanji: 1.太陽[ichi1,news1,nf04]
Readings: 1.たいよう[ichi1,news1,nf04]
Senses:
1. [n]
  1. sun
History:
1. A 2018-03-20 15:42:14 Johan Råde&lt;johan.rade@gmail.com&gt;
  Diff:
    @@ -19 +18,0 @@
    -&lt;gloss&gt;solar&lt;/gloss&gt;</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_3_setup_web_access">3. Setup Web Access</h3>
<div class="sect3">
<h4 id="apache_config">3.1. Apache Configuration</h4>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
This need only be done once.  If you&#8217;ve configured Apache to
serve the pages from {{DEVDIR}} in the past you can continue to
use that configuration unless the directory location or URL root
you want to use has changed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Section
<a href="install.html#apache_config">5.Configuring_the_apache_webserver</a>
in the <a href="install.html">Install documentation</a>
describes how to create a configuration file or section in an existing
configuration file for web access to the main production instance of
JMdictDB.  For development access you will do the same thing but use a
different name for the process group and root URL.  For example,
changing the process group name from "jmapp" (used in the Section 5
example) to "jmdev" would result in a configuration section like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>WSGIDaemonProcess jmdev processes=2 threads=2 \
    display-name=apache2-jmdev locale=en_US.UTF-8 lang=en_US.UTF-8
WSGIProcessGroup jmdev
WSGIScriptAlias /{{URLROOT}} {{DEVDIR}}/web/cgi/jmapp.wsgi \
    process-group=jmdev

  # Serve static files directly without using the app.
Alias "/{{URLROOT}}/web/" "{{DEVDIR}}/web/"
&lt;Directory {{DEVDIR}}/web/&gt;
    DirectoryIndex disabled
    Require all granted
    &lt;/Directory&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>Of course replace {{DEVDIR}} with the directory path you checked the
JMdictDB code out to and {{URLROOT}} with the value you wish to use.
This configuration section can go in the same file as the production
configuration  or in a separate file, whatever is most convenient.</p>
</div>
<div class="paragraph">
<p>The web server will need to be restarted in order for it to read the
new configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="config_ini">3.2. Config and log files</h4>
<div class="paragraph">
<p>See section
<a href="install.html#config_ini">6.Create a config.ini file for web settings</a>
in the
<a href="install.html">Install documentation</a>
for general instructions on the config files.3.1</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Since the web files will be served directly from {{DEVDIR}} the
config.ini and config-pvt.ini files should be created in
{{DEVDIR}}/web/lib/.  config.ini can be empty if the default
settings described in config-sample.ini are ok.</p>
</li>
<li>
<p>The config-pvt.ini file must contain a [db_{{DEVDB-SVC}}] section
to allow web access to your development database.
&lt;DEVDB-SVC&gt; is the "service name" used in URLs as the &amp;svc=&#8230;&#8203;" value.
The author finds that naming the service section anything other
than "db_{{DEVDB}}" (that is, not making the service name the same
as the database name) inevitably leads to confusion.</p>
</li>
<li>
<p>There must (as always) also be a [db_session] section present to
identify the user database.</p>
</li>
<li>
<p>If you wish to preclude accessing, say, the production "jmdict"
database from the development code, you can remove or not add a
[db_jmdict] section.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Create a jmdictdb.log file in {{DEVDIR}}/web/lib/ (or wherever you
you specified config.ini if you you overrode the default
name or location in config.ini.</p>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to set the owner, group and permissions on the files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>config-pvt.ini should not be world-readable but must be readable
by the web server.</p>
</li>
<li>
<p>The log file must be writable by the web server.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_3_3_check_access">3.3. Check access</h4>
<div class="paragraph">
<p>At this point you should be able to access the development database
with via the web pages.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>\http://localhost/{{URLROOT}}/srchform.py?svc={{DEVDB-SVC}}</pre>
</div>
</div>
<div class="paragraph">
<p>where {{URLROOT}} is the root URL for the development files configured in
step <a href="#apache-config">[apache-config]</a> above and {{DEVDB-SVC}} is the database access service
for your development database that was added to config-pvt.ini
in step <a href="#config_ini">3.2. Config and log files</a>.</p>
</div>
<div class="paragraph">
<p>If you get an error, please check section
<a href="install.html#errors">7. Common errors that may occur when trying to access a web page</a>
in the <a href="install.html">Install documentation</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_4_tools">4. Tools</h3>
<div class="paragraph">
<p>Tools that may be useful during development activities are located
in the tools/ directory.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tools/dbversion.py&#8201;&#8212;&#8201;Will report if the current code is compatible
with a given database.</p>
</li>
<li>
<p><a href="https://localhost/{{URLROOT}}cgiinfo.py&#8201;&#8212;&#8201;A" class="bare">https://localhost/{{URLROOT}}cgiinfo.py&#8201;&#8212;&#8201;A</a> web page that will report
details about the current development environment, most importantly where
the library modules being used by the web pages are coming from.  This
can help diagnose subtle problems when the code is inadvertently accessing
installed (and possibly older) versions of library code rather than that
from the development directory.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-11-23 12:51:56 MST
</div>
</div>
</body>
</html>